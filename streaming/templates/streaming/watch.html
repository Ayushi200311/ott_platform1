{% extends 'streaming/base.html' %}
{% load static %}

{% block title %}
  {{ series.title }} - Season {{ series.season }} Episode {{ series.episode }}
{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/watch.css' %}">
  <style>
    .video-container {
      position: relative;
      padding-bottom: 56.25%;
      height: 0;
      overflow: hidden;
      background: #000;
    }
    .video-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }
    .video-fallback {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      background: #222;
    }
  </style>
{% endblock %}

{% block content %}
<div class="video-container">
  <!-- Simple iframe embed without API first -->
  <iframe id="youtube-embed"
    src="https://www.youtube.com/embed/{{ series.youtube_id }}?rel=0&modestbranding=1"
    frameborder="0"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
    allowfullscreen>
  </iframe>
  <div class="video-fallback" style="display:none;">
    <a href="https://youtube.com/watch?v={{ series.youtube_id }}" target="_blank">
      Watch on YouTube
    </a>
  </div>
</div>

<!-- Rest of your content -->
{% endblock %}

{% block extra_js %}
<script>
// Self-contained, conflict-free implementation
(function() {
  // Remove duplicate scripts from the page
  function removeDuplicateScripts() {
    const scripts = document.querySelectorAll('script[src*="watch.js"], script[src*="home.js"]');
    scripts.forEach(script => script.remove());
  }

  // Initialize YouTube embed
  function initYouTubeEmbed() {
    const iframe = document.getElementById('youtube-embed');
    const fallback = document.querySelector('.video-fallback');
    
    // Check if iframe loaded properly
    setTimeout(() => {
      try {
        // If iframe doesn't have proper src, show fallback
        if (!iframe.src.includes('{{ series.youtube_id }}')) {
          iframe.style.display = 'none';
          fallback.style.display = 'flex';
        }
      } catch (e) {
        console.error('YouTube embed check failed:', e);
        iframe.style.display = 'none';
        fallback.style.display = 'flex';
      }
    }, 3000);
  }

  // Safe slider implementation
  function initSlider() {
    const sliderSection = document.querySelector('.slider-section');
    if (!sliderSection) return;

    const slides = sliderSection.querySelectorAll('.slide');
    if (!slides || slides.length === 0) return;

    let currentSlide = 0;

    function showSlide(index) {
      // Validate index
      index = (index < 0) ? slides.length - 1 : index;
      index = (index >= slides.length) ? 0 : index;
      
      // Safely update classes
      try {
        slides.forEach((slide, i) => {
          if (slide && slide.classList) {
            slide.classList.toggle('active', i === index);
          }
        });
        currentSlide = index;
      } catch (e) {
        console.error('Slider error:', e);
      }
    }

    // Initialize controls
    const prevBtn = sliderSection.querySelector('#prev-slide');
    const nextBtn = sliderSection.querySelector('#next-slide');

    if (prevBtn) {
      prevBtn.addEventListener('click', () => showSlide(currentSlide - 1));
    }

    if (nextBtn) {
      nextBtn.addEventListener('click', () => showSlide(currentSlide + 1));
    }

    // Initialize first slide
    showSlide(0);
  }

  // Main initialization
  document.addEventListener('DOMContentLoaded', function() {
    removeDuplicateScripts();
    initYouTubeEmbed();
    initSlider();
  });
})();
</script>
{% endblock %}